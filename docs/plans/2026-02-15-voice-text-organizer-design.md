# 通用语音整理桌面工具设计文档（Windows）

## 1. 背景与目标

用户希望通过后台常驻桌面应用，将口语输入快速转换为清晰、通用、可直接使用的文本。工具应避免固定在会议纪要场景，而是支持任意“表达整理”和“口头命令重构”。

核心目标：
- 长按 `Alt` 开始录音，松开结束，自动完成语音转文字与语言整理。
- 输出直接插入当前光标位置，不需要手动复制粘贴。
- 若当前存在选中文本，再次长按 `Alt` 可基于新语音对选区进行重转化替换。
- 默认使用云端 API，支持主动切换到本地 Ollama 模型。
- 第一版支持中文与英文。

## 2. 范围

MVP 范围：
- Windows 平台后台常驻。
- 全局热键（`Alt` 长按触发录音）。
- 录音后一次性处理（非实时）。
- 语音转文字 + 通用语言整理。
- 光标处插入或选区替换。
- 云端默认、本地可切换。

非目标（MVP 不做）：
- 实时边说边出字。
- 多语言扩展（除中英外）。
- 复杂文档编辑器插件化集成。

## 3. 交互设计

### 3.1 标准流程（无选区）
1. 用户长按 `Alt`（超过阈值，例如 250ms）触发录音。
2. 松开 `Alt` 自动结束录音并发起处理。
3. 系统完成 ASR 与整理，得到最终文本。
4. 文本直接输入到当前焦点光标位置。

### 3.2 重转化流程（有选区）
1. 触发前读取当前选中文本（复制后恢复原剪贴板）。
2. 长按 `Alt` 录入新的修订语音。
3. 系统将“选区文本 + 新语音”送入整理流程。
4. 返回结果直接替换当前选区。

## 4. 技术方案（已选）

采用 “AutoHotkey v2 + Python 本地服务” 双进程架构：
- `AutoHotkey v2`：负责全局热键、选区读写、文本注入。
- `Python Service`：负责录音、ASR、整理、模型路由、结果返回。

两者通过 `localhost HTTP` 通信，降低调试复杂度并保持清晰边界。

## 5. 逻辑流水线

1. 输入层（AHK）捕获触发上下文（是否有选区）。
2. 音频层（Python）采集音频并生成临时 wav。
3. ASR 层将语音转文本（中英）。
4. Rewrite 层执行“去冗余 + 提核心 + 重组逻辑”。
5. 输出层返回最终文本，AHK 完成注入/替换。

## 6. 模型与路由策略

- 默认模式：云端 API（质量优先）。
- 可选模式：本地 Ollama（隐私与成本优先）。
- 可配置兜底：云端失败后自动切本地，或直接失败提示。

路由输入字段建议：
- `mode`: `cloud` | `local`
- `language_hint`: `zh` | `en` | `auto`
- `selected_text`: 可空
- `voice_text`: ASR 输出

## 7. 输出规范（通用整理）

目标是“通用可执行文本”，不限定在特定模板：
- 删除语气词、口头重复、无关噪声。
- 保持原意，不新增事实。
- 优先输出自然段；必要时拆成短要点。
- 中英混说时保留语义准确性，不强行统一语种。

## 8. 配置与安全

配置项建议：
- `trigger.long_press_ms`
- `model.default_mode`（默认 `cloud`）
- `model.fallback_to_local_on_cloud_error`
- `asr.language`（`auto`）
- `rewrite.style`（`general_clean`）

安全约束：
- API Key 仅从环境变量读取（例如 `SILICONFLOW_API_KEY`）。
- 不在代码、配置文件、日志中明文保存密钥。
- 日志默认不落明文文本，仅记录状态与耗时。

## 9. 异常处理

- 麦克风不可用：提示并中止。
- 按键误触：仅超过长按阈值才开始录音。
- 无有效语音：返回可理解提示，不覆盖原内容。
- ASR/LLM 超时：快速失败并提示重试。
- 选区替换失败：降级为当前光标插入。

## 10. 验收标准（MVP）

- `Alt` 长按录音 + 松开处理，触发成功率 >= 95%。
- 中文和英文语音均可完成转写与整理。
- 输出相对原始转写明显减少冗余，逻辑更清晰。
- 选区重转化可稳定替换目标文本。
- 默认云端可用，设置中可切换本地 Ollama。

## 11. 后续迭代

- 实时流式模式（边说边转）。
- 多供应商 API 插件化。
- 文本风格预设（命令式、邮件式、简报式）。
- 用户词典与术语记忆。

